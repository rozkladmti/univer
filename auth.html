<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö—ñ–¥ —É —Å–∏—Å—Ç–µ–º—É</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
        }
        
        .login-container {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .logo {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        h1 {
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
        }
        
        p {
            color: #64748b;
            margin-bottom: 2rem;
        }
        
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .info {
            background: #dbeafe;
            color: #1e40af;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .loading {
            display: none;
            margin-top: 1rem;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .g_id_signin {
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">üéì</div>
        <h1>–°–∏—Å—Ç–µ–º–∞ —Ä–æ–∑–∫–ª–∞–¥—É</h1>
        <p>–£–≤—ñ–π–¥—ñ—Ç—å –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Google –∞–∫–∞—É–Ω—Ç—É</p>
        
        <div id="error" class="error"></div>
        
        <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
        <div class="info">
            ‚ö†Ô∏è –ü–µ—Ä–µ–¥ –ø–µ—Ä—à–∏–º –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º:<br>
            1. –°—Ç–≤–æ—Ä—ñ—Ç—å –∞—Ä–∫—É—à "Users" —É Google Sheets<br>
            2. –î–æ–¥–∞–π—Ç–µ —Å–≤—ñ–π email –∑ —Ä–æ–ª–ª—é 'admin'<br>
            3. –ó–∞–º—ñ–Ω—ñ—Ç—å YOUR_CLIENT_ID –Ω–∏–∂—á–µ
        </div>
        
        <!-- Google Sign-In Button -->
        <div id="g_id_onload"
             data-client_id="603262964237-43b87sf49pc47icl2j4qi40v3br7q9qj.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="signin_with"
             data-shape="rectangular"
             data-logo_alignment="left">
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É...</p>
        </div>
    </div>

    <script>
        // ==========================================
        // –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø - –ó–ê–ú–Ü–ù–Ü–¢–¨ –¶–Ü –ó–ù–ê–ß–ï–ù–ù–Ø!
        // ==========================================
        
        // 1. –û—Ç—Ä–∏–º–∞–π—Ç–µ URL –ø—ñ—Å–ª—è –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó Apps Script (Deploy > New deployment > Web app)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx2KoOb0WtvF0XWVGe906fl7G3MK85q4WItwPSm8YeQ6hMFwUXh9CmepF6wc-JsKPvH/exec';
        
        // 2. Client ID –æ—Ç—Ä–∏–º–∞–π—Ç–µ –∑ Google Cloud Console
        // const CLIENT_ID –≤–∂–µ –≤–∫–∞–∑–∞–Ω–∏–π —É data-client_id –≤–∏—â–µ
        
        // ==========================================
        
        function handleCredentialResponse(response) {
            const idToken = response.credential;
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            
            // –†–æ–∑—à–∏—Ñ—Ä–æ–≤—É—î–º–æ JWT —Ç–æ–∫–µ–Ω (–±–∞–∑–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è)
            const payload = parseJwt(idToken);
            const email = payload.email;
            
            console.log('–°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó:', email);
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ä–æ–ª—ñ
            fetch(SCRIPT_URL + '?action=verify', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞:', data);
                
                if (data.result === 'success' && data.user.authenticated) {
                    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç–æ–∫–µ–Ω —Ç–∞ —ñ–Ω—Ñ–æ –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                    localStorage.setItem('authToken', idToken);
                    localStorage.setItem('userEmail', email);
                    localStorage.setItem('userRole', data.user.role);
                    localStorage.setItem('userName', data.user.name);
                    
                    console.log('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞. –†–æ–ª—å:', data.user.role);
                    
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
                    redirectByRole(data.user.role);
                } else {
                    showError(data.message || '–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
                    console.error('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤—ñ–¥—Ö–∏–ª–µ–Ω–∞:', data);
                }
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó:', error);
                showError('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ: \n1. –ß–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π SCRIPT_URL\n2. –ß–∏ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–∏–π Apps Script\n3. –ß–∏ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –∞—Ä–∫—É—à Users');
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none';
            });
        }
        
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É JWT:', e);
                return {};
            }
        }
        
        function redirectByRole(role) {
            console.log('–†–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –¥–ª—è —Ä–æ–ª—ñ:', role);
            
            switch(role) {
                case 'admin':
                    window.location.href = 'admin.html';
                    break;
                case 'teacher':
                    window.location.href = 'teacher.html';
                    break;
                case 'student':
                    window.location.href = 'student.html';
                    break;
                default:
                    showError('–ù–µ–≤—ñ–¥–æ–º–∞ —Ä–æ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ' + role);
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π
        window.onload = function() {
            const token = localStorage.getItem('authToken');
            const role = localStorage.getItem('userRole');
            
            console.log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É—é—á–æ—ó —Å–µ—Å—ñ—ó...');
            
            if (token && role) {
                console.log('–ó–Ω–∞–π–¥–µ–Ω–∞ —ñ—Å–Ω—É—é—á–∞ —Å–µ—Å—ñ—è –¥–ª—è —Ä–æ–ª—ñ:', role);
                // –Ø–∫—â–æ —î —Ç–æ–∫–µ–Ω - –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –π–æ–≥–æ –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å
                checkTokenValidity(token, role);
            } else {
                console.log('–°–µ—Å—ñ—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞. –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...');
            }
        };
        
        function checkTokenValidity(token, role) {
            try {
                const payload = parseJwt(token);
                const now = Date.now() / 1000;
                
                if (payload.exp && payload.exp > now) {
                    // –¢–æ–∫–µ–Ω —â–µ –¥—ñ–π—Å–Ω–∏–π - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ
                    console.log('–¢–æ–∫–µ–Ω –≤–∞–ª—ñ–¥–Ω–∏–π. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ä–µ–¥—ñ—Ä–µ–∫—Ç...');
                    redirectByRole(role);
                } else {
                    // –¢–æ–∫–µ–Ω –∑–∞—Å—Ç–∞—Ä—ñ–≤ - –æ—á–∏—â–∞—î–º–æ
                    console.log('–¢–æ–∫–µ–Ω –∑–∞—Å—Ç–∞—Ä—ñ–≤. –û—á–∏—â–µ–Ω–Ω—è —Å–µ—Å—ñ—ó...');
                    localStorage.clear();
                }
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç–æ–∫–µ–Ω—É:', e);
                localStorage.clear();
            }
        }
        
        // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        console.log('=== AUTH.HTML –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ===');
        console.log('SCRIPT_URL:', SCRIPT_URL);
        console.log('–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ URL –Ω–µ –º—ñ—Å—Ç–∏—Ç—å YOUR_SCRIPT_ID');
    </script>
</body>
</html>
